generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////
// Enums
//////////////////////////////

enum Role {
  ADMIN
  OWNER
  STAFF
  TENANT
}

enum VerifyChannel {
  EMAIL
  PHONE
}

enum CondoStatus {
  ACTIVE
  INACTIVE
}

enum AssetType {
  LOGO
  COVER
  GALLERY
  DOCUMENT
}

enum UtilityType {
  WATER
  ELECTRIC
}

enum BillingCycle {
  MONTHLY
  ONE_TIME
}

enum OccupancyStatus {
  VACANT
  OCCUPIED
  RESERVED
}

enum RoomStatus {
  NORMAL
  MAINTENANCE
  BLOCKED
}

enum CodeStatus {
  ACTIVE
  USED
  EXPIRED
  DISABLED
}

enum ResidencyStatus {
  ACTIVE
  ENDED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED
  CONVERTED_TO_CONTRACT
}

enum ContractStatus {
  ACTIVE
  ENDED
  CANCELLED
}

enum PermissionModule {
  DASHBOARD
  ROOMS
  BILLING
  PAYMENT
  REPAIR
  PARCEL
  FACILITY
  ANNOUNCE
  CHAT
  TENANT
  STAFF
}

enum AnnouncementStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ChatMessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum RepairPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum RepairStatus {
  OPEN
  IN_PROGRESS
  WAITING_PARTS
  DONE
  CANCELLED
}

enum AttachmentType {
  IMAGE
  VIDEO
  OTHER
}

enum ParcelStatus {
  RECEIVED
  NOTIFIED
  PICKED_UP
  RETURNED
}

enum NotifyChannel {
  LINE
  SMS
  EMAIL
}

enum FacilityBookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  COMPLETED
}

enum FacilityBookingUpdateType {
  COMMENT
  STATUS_CHANGE
  APPROVAL
}

enum MeterCycleStatus {
  OPEN
  CLOSED
}

enum MeterReadingStatus {
  PENDING
  SUBMITTED
  APPROVED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  OVERDUE
  CANCELLED
}

enum InvoiceItemType {
  RENT
  WATER
  ELECTRIC
  CHARGE
  EXTRA
  DISCOUNT
  PENALTY
  OTHER
  FACILITY
}

enum PaymentMethod {
  TRANSFER
  PROMPTPAY
  CASH
}

enum PaymentNoticeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentTxnStatus {
  PENDING
  CONFIRMED
  VOID
}

enum TenantNotificationType {
  ANNOUNCE
  INVOICE
  PAYMENT
  PARCEL
  REPAIR
  FACILITY
  CHAT
}

enum OnboardingChannel {
  LINE
  WEB
}

enum OnboardingEventType {
  ENTER_CODE
  LINK_SUCCESS
  LINK_FAILED
}

enum RepairUpdateType {
  COMMENT
  STATUS_CHANGE
  ASSIGNMENT
  SCHEDULE
}

//////////////////////////////
// 0) Core / Users / Platform Admin
//////////////////////////////

model User {
  id           String  @id @default(uuid()) @db.Uuid
  email        String? @unique
  phone        String? @unique
  passwordHash String?

  role     Role    @default(TENANT)
  name     String?
  isActive Boolean @default(true)

  // Auth status (needed by auth.routes.ts)
  verifyChannel   VerifyChannel @default(EMAIL)
  emailVerifiedAt DateTime?
  phoneVerifiedAt DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime?     @updatedAt

  // Relations (existing)
  auditLogsActed AuditLog[] @relation("AuditActor")
  condosOwned    Condo[]    @relation("CondoOwner")

  condoAssetsUploaded CondoAsset[] @relation("CondoAssetUploader")

  tenantProfile TenantProfile?
  lineAccount   LineAccount?

  tenantCodesUsed    TenantRoomCode[] @relation("TenantCodeUsedBy")
  tenantCodesCreated TenantRoomCode[] @relation("TenantCodeCreatedBy")

  residencies TenantResidency[] @relation("ResidencyTenant")

  reservationsCreated RoomReservation[] @relation("ReservationCreatedBy")

  staffInvitesCreated StaffInvite[] @relation("StaffInviteCreatedBy")

  announcementsCreated Announcement[]     @relation("AnnouncementCreatedBy")
  announcementReads    AnnouncementRead[] @relation("AnnouncementReadByTenant")

  chatRoomsCreated ChatRoom[]        @relation("ChatRoomCreatedBy")
  chatRoomMembers  ChatRoomMember[]
  chatMessages     ChatMessage[]
  chatMessageReads ChatMessageRead[]

  repairRequestsCreated     RepairRequest[]    @relation("RepairCreatedBy")
  repairAttachmentsUploaded RepairAttachment[] @relation("RepairAttachmentUploadedBy")
  repairUpdatesCreated      RepairUpdate[]     @relation("RepairUpdateCreatedBy")

  parcelAttachmentsUploaded ParcelAttachment[] @relation("ParcelAttachmentUploadedBy")

  facilityBookingsCreated  FacilityBooking[] @relation("FacilityBookingCreatedBy")
  facilityBookingsApproved FacilityBooking[] @relation("FacilityBookingApprovedBy")

  meterCyclesOpened MeterCycle[] @relation("MeterCycleOpenedBy")
  meterCyclesClosed MeterCycle[] @relation("MeterCycleClosedBy")

  meterReadingsRecorded MeterReading[] @relation("MeterReadingRecordedBy")

  invoicesCreated Invoice[] @relation("InvoiceCreatedBy")

  paymentNoticesReviewed PaymentNotice[]      @relation("PaymentReviewedBy")
  paymentTxnsConfirmed   PaymentTransaction[] @relation("PaymentConfirmedBy")
  paymentUpdatesMade     PaymentUpdate[]      @relation("PaymentUpdateBy")

  tenantNotifications TenantNotification[] @relation("TenantNotificationUser")

  onboardingEvents TenantOnboardingEvent[] @relation("TenantOnboardingUser")

  // ✅ Added missing opposite relations (fix validate errors)
  roomStatusChanges RoomStatusHistory[] @relation("RoomStatusChangedBy")

  rentalContracts RentalContract[] @relation("ContractTenant")

  staffMemberships StaffMembership[] @relation("UserStaffMembership")

  tenantRepairRequests   RepairRequest[]   @relation("RepairTenant")
  tenantParcels          Parcel[]          @relation("ParcelTenant")
  tenantFacilityBookings FacilityBooking[] @relation("FacilityBookingTenant")
  tenantPaymentNotices   PaymentNotice[]   @relation("PaymentNoticeTenant")

  facilityBookingUpdatesCreated FacilityBookingUpdate[] @relation("FacilityBookingUpdateCreatedBy")

  // Auth flows
  verifyRequests        VerifyRequest[]
  passwordResetRequests PasswordResetRequest[]
}

model AuditLog {
  id          String  @id @default(uuid()) @db.Uuid
  actorUserId String? @db.Uuid
  action      String
  entityType  String?
  entityId    String? @db.Uuid

  ip        String?
  userAgent String?
  meta      Json?

  createdAt DateTime @default(now())

  actor User? @relation("AuditActor", fields: [actorUserId], references: [id])

  @@index([actorUserId])
}

//////////////////////////////
// Auth flows
//////////////////////////////

model VerifyRequest {
  id      String        @id @default(uuid()) @db.Uuid
  userId  String        @db.Uuid
  channel VerifyChannel

  emailCodeHash String?
  phoneOtpHash  String?

  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordResetRequest {
  id        String        @id @default(uuid()) @db.Uuid
  userId    String        @db.Uuid
  channel   VerifyChannel
  codeHash  String
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

//////////////////////////////
// 1) Condo + Assets + Bank + Utility
//////////////////////////////

model Condo {
  id          String @id @default(uuid()) @db.Uuid
  ownerUserId String @db.Uuid

  condoName   String
  description String?

  addressLine1 String?
  addressLine2 String?
  province     String?
  district     String?
  subdistrict  String?
  postcode     String?

  totalFloors Int?

  status CondoStatus @default(ACTIVE)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  owner User @relation("CondoOwner", fields: [ownerUserId], references: [id])

  assets         CondoAsset[]
  bankAccounts   CondoBankAccount[]
  utilitySetting UtilitySetting?
  utilityRates   UtilityRate[]

  rooms Room[]

  chargeSettings       CondoCharge[]
  extraChargeTemplates ExtraChargeTemplate[]

  staffInvites             StaffInvite[]
  staffMemberships         StaffMembership[]
  staffPermissionTemplates StaffPermissionTemplate[] // ✅ opposite for StaffPermissionTemplate.condo

  announcements Announcement[]
  chatRooms     ChatRoom[]

  repairRequests RepairRequest[]
  parcels        Parcel[]

  facilities       Facility[]
  facilityBookings FacilityBooking[]

  meterCycles   MeterCycle[]
  meterReadings MeterReading[]

  invoices    Invoice[]
  paymentTxns PaymentTransaction[]

  tenantCodes  TenantRoomCode[]
  residencies  TenantResidency[]
  reservations RoomReservation[]
  contracts    RentalContract[]

  tenantNotifications TenantNotification[]
  dashboardSnapshots  DashboardDailySnapshot[]
  reportSnapshots     ReportMonthlySnapshot[]

  @@index([ownerUserId])
}

model CondoAsset {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  assetType AssetType
  fileUrl   String
  fileName  String?
  mimeType  String?
  sizeBytes BigInt?

  isPrimary  Boolean @default(false)
  uploadedBy String? @db.Uuid

  createdAt DateTime @default(now())

  condo    Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
  uploader User? @relation("CondoAssetUploader", fields: [uploadedBy], references: [id])

  @@index([condoId])
}

model CondoBankAccount {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  bankName    String
  accountName String
  accountNo   String

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  paymentNotices PaymentNotice[]
  paymentTxns    PaymentTransaction[]

  @@index([condoId])
}

model UtilitySetting {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @unique @db.Uuid

  waterEnabled    Boolean @default(true)
  electricEnabled Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
}

model UtilityRate {
  id          String      @id @default(uuid()) @db.Uuid
  condoId     String      @db.Uuid
  utilityType UtilityType
  ratePerUnit Decimal     @db.Decimal(12, 2)

  effectiveFrom DateTime  @db.Date
  effectiveTo   DateTime? @db.Date

  createdAt DateTime @default(now())

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  @@index([condoId, utilityType])
}

//////////////////////////////
// 4) Charges
//////////////////////////////

model ChargeCatalog {
  id          String  @id @default(uuid()) @db.Uuid
  code        String  @unique
  nameTh      String
  description String?
  isActive    Boolean @default(true)

  condoCharges CondoCharge[]
}

model CondoCharge {
  id        String @id @default(uuid()) @db.Uuid
  condoId   String @db.Uuid
  catalogId String @db.Uuid

  amount       Decimal      @db.Decimal(12, 2)
  billingCycle BillingCycle @default(MONTHLY)
  isActive     Boolean      @default(true)

  createdAt DateTime @default(now())

  condo   Condo         @relation(fields: [condoId], references: [id], onDelete: Cascade)
  catalog ChargeCatalog @relation(fields: [catalogId], references: [id])

  roomCharges  RoomCharge[]
  invoiceItems InvoiceItem[]

  @@index([condoId])
  @@index([catalogId])
}

model RoomCharge {
  id            String @id @default(uuid()) @db.Uuid
  roomId        String @db.Uuid
  condoChargeId String @db.Uuid

  isEnabled      Boolean  @default(true)
  amountOverride Decimal? @db.Decimal(12, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  room        Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  condoCharge CondoCharge @relation(fields: [condoChargeId], references: [id], onDelete: Cascade)

  @@unique([roomId, condoChargeId])
  @@index([roomId])
  @@index([condoChargeId])
}

model ExtraChargeTemplate {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  templateName  String
  defaultAmount Decimal      @db.Decimal(12, 2)
  billingCycle  BillingCycle @default(MONTHLY)
  isActive      Boolean      @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  roomAssignments RoomExtraChargeAssignment[]
  invoiceItems    InvoiceItem[]

  @@index([condoId])
}

model RoomExtraChargeAssignment {
  id         String @id @default(uuid()) @db.Uuid
  roomId     String @db.Uuid
  templateId String @db.Uuid

  isEnabled      Boolean  @default(true)
  amountOverride Decimal? @db.Decimal(12, 2)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  room     Room                @relation(fields: [roomId], references: [id], onDelete: Cascade)
  template ExtraChargeTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([roomId, templateId])
  @@index([roomId])
  @@index([templateId])
}

//////////////////////////////
// 5) Rooms + Meters + Status histories
//////////////////////////////

model Room {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  roomNo String
  floor  Int

  rentPrice Decimal  @db.Decimal(12, 2)
  deposit   Decimal? @db.Decimal(12, 2)
  size      Decimal? @db.Decimal(12, 2)

  isActive Boolean @default(true)

  occupancyStatus OccupancyStatus @default(VACANT)
  roomStatus      RoomStatus      @default(NORMAL)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  statusHistories RoomStatusHistory[]
  meter           RoomMeter?

  roomCharges            RoomCharge[]
  extraChargeAssignments RoomExtraChargeAssignment[]

  reservations RoomReservation[]
  contracts    RentalContract[]
  residencies  TenantResidency[]
  chatRooms    ChatRoom[]

  repairRequests RepairRequest[]
  parcels        Parcel[]

  facilityBookings FacilityBooking[]

  meterReadings MeterReading[]
  invoices      Invoice[]

  tenantCodes TenantRoomCode[]

  @@unique([condoId, roomNo])
  @@index([condoId])
}

model RoomStatusHistory {
  id     String @id @default(uuid()) @db.Uuid
  roomId String @db.Uuid

  oldOccupancyStatus OccupancyStatus?
  newOccupancyStatus OccupancyStatus?
  oldRoomStatus      RoomStatus?
  newRoomStatus      RoomStatus?

  changedBy String?  @db.Uuid
  changedAt DateTime @default(now())
  note      String?

  room    Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  changer User? @relation("RoomStatusChangedBy", fields: [changedBy], references: [id]) // ✅ named relation

  @@index([roomId])
}

model RoomMeter {
  id     String @id @default(uuid()) @db.Uuid
  roomId String @unique @db.Uuid

  waterMeterNo    String?
  electricMeterNo String?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

//////////////////////////////
// 6) Tenant Identity + Residency + Codes
//////////////////////////////

model TenantProfile {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid

  fullName String
  phone    String?

  idType   String
  idNumber String
  address  String?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  emergencyContacts TenantEmergencyContact[]
}

model TenantEmergencyContact {
  id              String @id @default(uuid()) @db.Uuid
  tenantProfileId String @db.Uuid

  contactName  String
  relationship String?
  phone        String
  note         String?

  createdAt DateTime @default(now())

  tenantProfile TenantProfile @relation(fields: [tenantProfileId], references: [id], onDelete: Cascade)

  @@index([tenantProfileId])
}

model LineAccount {
  id     String @id @default(uuid()) @db.Uuid
  userId String @unique @db.Uuid

  lineUserId  String  @unique
  displayName String?
  pictureUrl  String?

  linkedAt DateTime @default(now())
  isActive Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  onboardingEvents TenantOnboardingEvent[] // ✅ opposite for TenantOnboardingEvent.lineAccount
}

model TenantRoomCode {
  id         String  @id @default(uuid()) @db.Uuid
  condoId    String  @db.Uuid
  roomId     String  @db.Uuid
  contractId String? @db.Uuid

  code      String     @unique
  status    CodeStatus @default(ACTIVE)
  expiresAt DateTime?

  usedByUserId String?   @db.Uuid
  usedAt       DateTime?

  createdBy String?  @db.Uuid
  createdAt DateTime @default(now())

  condo    Condo           @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room     Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  contract RentalContract? @relation(fields: [contractId], references: [id])

  usedBy  User? @relation("TenantCodeUsedBy", fields: [usedByUserId], references: [id])
  creator User? @relation("TenantCodeCreatedBy", fields: [createdBy], references: [id])

  onboardingEvents TenantOnboardingEvent[] @relation("OnboardingByRoomCode")

  @@index([condoId])
  @@index([roomId])
  @@index([contractId])
}

model TenantResidency {
  id           String  @id @default(uuid()) @db.Uuid
  tenantUserId String  @db.Uuid
  condoId      String  @db.Uuid
  roomId       String  @db.Uuid
  contractId   String? @db.Uuid

  status    ResidencyStatus @default(ACTIVE)
  startDate DateTime        @db.Date
  endDate   DateTime?       @db.Date

  createdAt DateTime @default(now())

  tenant   User            @relation("ResidencyTenant", fields: [tenantUserId], references: [id], onDelete: Cascade)
  condo    Condo           @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room     Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  contract RentalContract? @relation(fields: [contractId], references: [id])

  @@index([tenantUserId])
  @@index([condoId])
  @@index([roomId])
  @@index([contractId])
}

model TenantOnboardingEvent {
  id            String  @id @default(uuid()) @db.Uuid
  tenantUserId  String? @db.Uuid
  lineAccountId String? @db.Uuid
  roomCodeId    String? @db.Uuid

  channel   OnboardingChannel   @default(LINE)
  eventType OnboardingEventType
  message   String?

  createdAt DateTime @default(now())

  tenant      User?           @relation("TenantOnboardingUser", fields: [tenantUserId], references: [id])
  lineAccount LineAccount?    @relation(fields: [lineAccountId], references: [id])
  roomCode    TenantRoomCode? @relation("OnboardingByRoomCode", fields: [roomCodeId], references: [id])

  @@index([tenantUserId])
  @@index([lineAccountId])
  @@index([roomCodeId])
}

//////////////////////////////
// 7) Reservation + Contract
//////////////////////////////

model RoomReservation {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid
  roomId  String @db.Uuid

  reservationNo String   @unique
  reservedAt    DateTime @default(now())
  moveInDate    DateTime @db.Date

  monthlyRent Decimal @db.Decimal(12, 2)
  bookingFee  Decimal @default(0) @db.Decimal(12, 2)

  status ReservationStatus @default(PENDING)

  createdBy String? @db.Uuid
  note      String?

  condo   Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room    Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  creator User? @relation("ReservationCreatedBy", fields: [createdBy], references: [id])

  contract RentalContract?

  @@index([condoId])
  @@index([roomId])
}

model RentalContract {
  id           String @id @default(uuid()) @db.Uuid
  condoId      String @db.Uuid
  roomId       String @db.Uuid
  tenantUserId String @db.Uuid

  reservationId String? @unique @db.Uuid // ✅ 1-1 must be unique

  moveInDate  DateTime  @db.Date
  moveOutDate DateTime? @db.Date

  monthlyRent     Decimal @db.Decimal(12, 2)
  securityDeposit Decimal @db.Decimal(12, 2)

  depositPaidBy     String
  bookingFeeApplied Decimal? @default(0) @db.Decimal(12, 2)

  status ContractStatus @default(ACTIVE)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo  Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room   Room  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenant User  @relation("ContractTenant", fields: [tenantUserId], references: [id], onDelete: Cascade) // ✅ named relation

  reservation RoomReservation? @relation(fields: [reservationId], references: [id])

  monthlyCharges ContractMonthlyCharge[]

  invoices  Invoice[]
  chatRooms ChatRoom[]

  // ✅ opposite relations for TenantRoomCode.contract + TenantResidency.contract
  tenantRoomCodes TenantRoomCode[]
  residencies     TenantResidency[]

  @@index([condoId])
  @@index([roomId])
  @@index([tenantUserId])
  @@index([reservationId])
}

model ContractMonthlyCharge {
  id         String @id @default(uuid()) @db.Uuid
  contractId String @db.Uuid

  itemName String
  amount   Decimal @db.Decimal(12, 2)
  source   String?

  createdAt DateTime @default(now())

  contract RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
}

//////////////////////////////
// 8) Staff / RBAC
//////////////////////////////

model StaffInvite {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  email         String
  token         String  @unique
  staffPosition String?

  status    String    @default("PENDING")
  expiresAt DateTime?

  createdBy String?  @db.Uuid
  createdAt DateTime @default(now())

  condo   Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
  creator User? @relation("StaffInviteCreatedBy", fields: [createdBy], references: [id])

  @@index([condoId])
}

model StaffMembership {
  id          String @id @default(uuid()) @db.Uuid
  staffUserId String @db.Uuid
  condoId     String @db.Uuid

  staffPosition String?
  isActive      Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  staff User  @relation("UserStaffMembership", fields: [staffUserId], references: [id], onDelete: Cascade) // ✅ named relation
  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  permissionAssignments StaffPermissionAssignment[]
  permissionOverrides   StaffPermissionOverride[]

  repairAssigned  RepairRequest[]
  parcelsReceived Parcel[]

  chatRoomMembers ChatRoomMember[]

  @@unique([staffUserId, condoId])
  @@index([condoId])
}

model PermissionCatalog {
  id       String           @id @default(uuid()) @db.Uuid
  code     String           @unique
  nameTh   String
  module   PermissionModule
  isActive Boolean          @default(true)

  templateItems StaffPermissionTemplateItem[]
  overrides     StaffPermissionOverride[]
}

model StaffPermissionTemplate {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  templateName String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  condo       Condo                         @relation(fields: [condoId], references: [id], onDelete: Cascade)
  items       StaffPermissionTemplateItem[]
  assignments StaffPermissionAssignment[]

  @@index([condoId])
}

model StaffPermissionTemplateItem {
  id           String  @id @default(uuid()) @db.Uuid
  templateId   String  @db.Uuid
  permissionId String  @db.Uuid
  allowed      Boolean @default(true)

  template   StaffPermissionTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  permission PermissionCatalog       @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([templateId, permissionId])
}

model StaffPermissionAssignment {
  id           String   @id @default(uuid()) @db.Uuid
  membershipId String   @db.Uuid
  templateId   String?  @db.Uuid
  createdAt    DateTime @default(now())

  membership StaffMembership          @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  template   StaffPermissionTemplate? @relation(fields: [templateId], references: [id])

  @@index([membershipId])
  @@index([templateId])
}

model StaffPermissionOverride {
  id           String   @id @default(uuid()) @db.Uuid
  membershipId String   @db.Uuid
  permissionId String   @db.Uuid
  allowed      Boolean
  createdAt    DateTime @default(now())

  membership StaffMembership   @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  permission PermissionCatalog @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([membershipId, permissionId])
}

//////////////////////////////
// 9) Announcements + Reads
//////////////////////////////

model Announcement {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  title         String
  content       String
  coverImageUrl String?

  status AnnouncementStatus @default(PUBLISHED)
  pinned Boolean            @default(false)

  publishedAt DateTime?
  createdBy   String?   @db.Uuid

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo   Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
  creator User? @relation("AnnouncementCreatedBy", fields: [createdBy], references: [id])

  reads AnnouncementRead[]

  @@index([condoId])
}

model AnnouncementRead {
  id             String   @id @default(uuid()) @db.Uuid
  announcementId String   @db.Uuid
  tenantUserId   String   @db.Uuid
  readAt         DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  tenant       User         @relation("AnnouncementReadByTenant", fields: [tenantUserId], references: [id], onDelete: Cascade)

  @@unique([announcementId, tenantUserId])
  @@index([tenantUserId])
}

//////////////////////////////
// 10) Chat
//////////////////////////////

model ChatRoom {
  id         String  @id @default(uuid()) @db.Uuid
  condoId    String  @db.Uuid
  roomId     String? @db.Uuid
  contractId String? @db.Uuid

  createdBy String?  @db.Uuid
  createdAt DateTime @default(now())

  condo    Condo           @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room     Room?           @relation(fields: [roomId], references: [id])
  contract RentalContract? @relation(fields: [contractId], references: [id])
  creator  User?           @relation("ChatRoomCreatedBy", fields: [createdBy], references: [id])

  members  ChatRoomMember[]
  messages ChatMessage[]

  @@index([condoId])
}

model ChatRoomMember {
  id                String  @id @default(uuid()) @db.Uuid
  chatRoomId        String  @db.Uuid
  userId            String  @db.Uuid
  staffMembershipId String? @db.Uuid

  joinedAt DateTime @default(now())
  isActive Boolean  @default(true)

  chatRoom        ChatRoom         @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffMembership StaffMembership? @relation(fields: [staffMembershipId], references: [id])

  @@unique([chatRoomId, userId])
}

model ChatMessage {
  id         String @id @default(uuid()) @db.Uuid
  chatRoomId String @db.Uuid

  senderUserId String          @db.Uuid
  messageType  ChatMessageType @default(TEXT)
  messageText  String?
  fileUrl      String?

  createdAt DateTime @default(now())

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation(fields: [senderUserId], references: [id], onDelete: Cascade)

  reads ChatMessageRead[]

  @@index([chatRoomId])
}

model ChatMessageRead {
  id        String   @id @default(uuid()) @db.Uuid
  messageId String   @db.Uuid
  userId    String   @db.Uuid
  readAt    DateTime @default(now())

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
}

//////////////////////////////
// 11) Repair
//////////////////////////////

model RepairRequest {
  id           String  @id @default(uuid()) @db.Uuid
  condoId      String  @db.Uuid
  roomId       String? @db.Uuid
  tenantUserId String? @db.Uuid
  createdBy    String? @db.Uuid

  title       String
  description String?

  priority RepairPriority @default(NORMAL)
  status   RepairStatus   @default(OPEN)

  assignedToMembershipId String?   @db.Uuid
  scheduledAt            DateTime?
  completedAt            DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo      Condo            @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room       Room?            @relation(fields: [roomId], references: [id])
  tenant     User?            @relation("RepairTenant", fields: [tenantUserId], references: [id]) // ✅ named + opposite exists in User
  creator    User?            @relation("RepairCreatedBy", fields: [createdBy], references: [id])
  assignedTo StaffMembership? @relation(fields: [assignedToMembershipId], references: [id])

  attachments RepairAttachment[]
  updates     RepairUpdate[]

  @@index([condoId])
}

model RepairAttachment {
  id       String @id @default(uuid()) @db.Uuid
  repairId String @db.Uuid

  fileUrl    String
  fileType   AttachmentType @default(IMAGE)
  uploadedBy String?        @db.Uuid
  createdAt  DateTime       @default(now())

  repair   RepairRequest @relation(fields: [repairId], references: [id], onDelete: Cascade)
  uploader User?         @relation("RepairAttachmentUploadedBy", fields: [uploadedBy], references: [id])

  @@index([repairId])
}

model RepairUpdate {
  id       String @id @default(uuid()) @db.Uuid
  repairId String @db.Uuid

  updateType RepairUpdateType
  message    String?

  oldStatus RepairStatus?
  newStatus RepairStatus?

  createdBy String?  @db.Uuid
  createdAt DateTime @default(now())

  repair  RepairRequest @relation(fields: [repairId], references: [id], onDelete: Cascade)
  creator User?         @relation("RepairUpdateCreatedBy", fields: [createdBy], references: [id])

  @@index([repairId])
}

//////////////////////////////
// 12) Parcels
//////////////////////////////

model Parcel {
  id           String  @id @default(uuid()) @db.Uuid
  condoId      String  @db.Uuid
  roomId       String? @db.Uuid
  tenantUserId String? @db.Uuid

  trackingNo String?
  carrier    String?
  senderName String?

  receivedAt             DateTime @default(now())
  receivedByMembershipId String?  @db.Uuid

  status     ParcelStatus @default(RECEIVED)
  pickedUpAt DateTime?
  pickedUpBy String?
  pickupNote String?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo      Condo            @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room       Room?            @relation(fields: [roomId], references: [id])
  tenant     User?            @relation("ParcelTenant", fields: [tenantUserId], references: [id]) // ✅ named + opposite exists in User
  receivedBy StaffMembership? @relation(fields: [receivedByMembershipId], references: [id])

  attachments   ParcelAttachment[]
  notifications ParcelNotification[]

  @@index([condoId])
}

model ParcelAttachment {
  id         String   @id @default(uuid()) @db.Uuid
  parcelId   String   @db.Uuid
  fileUrl    String
  uploadedBy String?  @db.Uuid
  createdAt  DateTime @default(now())

  parcel   Parcel @relation(fields: [parcelId], references: [id], onDelete: Cascade)
  uploader User?  @relation("ParcelAttachmentUploadedBy", fields: [uploadedBy], references: [id])

  @@index([parcelId])
}

model ParcelNotification {
  id       String @id @default(uuid()) @db.Uuid
  parcelId String @db.Uuid

  channel      NotifyChannel @default(LINE)
  sentTo       String?
  sentAt       DateTime      @default(now())
  status       String        @default("SENT")
  errorMessage String?

  parcel Parcel @relation(fields: [parcelId], references: [id], onDelete: Cascade)

  @@index([parcelId])
}

//////////////////////////////
// 13) Facility Booking
//////////////////////////////

model Facility {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  facilityName  String
  description   String?
  coverImageUrl String?

  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  bookingSetting FacilityBookingSetting?
  bookings       FacilityBooking[]

  @@index([condoId])
}

model FacilityBookingSetting {
  id         String @id @default(uuid()) @db.Uuid
  facilityId String @unique @db.Uuid

  openTime  DateTime? @db.Time
  closeTime DateTime? @db.Time

  slotMinutes       Int     @default(60)
  maxPeople         Int?
  maxBookingsPerDay Int?
  requiresApproval  Boolean @default(false)

  feePerSlot Decimal @default(0) @db.Decimal(12, 2)
  deposit    Decimal @default(0) @db.Decimal(12, 2)

  cancellationHours Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime? @updatedAt

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
}

model FacilityBooking {
  id         String @id @default(uuid()) @db.Uuid
  condoId    String @db.Uuid
  facilityId String @db.Uuid

  roomId       String? @db.Uuid
  tenantUserId String? @db.Uuid
  createdBy    String? @db.Uuid

  bookingDate DateTime @db.Date
  startTime   DateTime @db.Time
  endTime     DateTime @db.Time

  peopleCount Int?
  note        String?

  status FacilityBookingStatus @default(PENDING)

  approvedBy   String?   @db.Uuid
  approvedAt   DateTime?
  rejectReason String?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo    Condo    @relation(fields: [condoId], references: [id], onDelete: Cascade)
  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  room     Room?    @relation(fields: [roomId], references: [id])
  tenant   User?    @relation("FacilityBookingTenant", fields: [tenantUserId], references: [id]) // ✅ named + opposite exists
  creator  User?    @relation("FacilityBookingCreatedBy", fields: [createdBy], references: [id])
  approver User?    @relation("FacilityBookingApprovedBy", fields: [approvedBy], references: [id])

  updates      FacilityBookingUpdate[]
  invoiceItems InvoiceItem[]

  @@index([condoId])
  @@index([facilityId])
}

model FacilityBookingUpdate {
  id         String                    @id @default(uuid()) @db.Uuid
  bookingId  String                    @db.Uuid
  updateType FacilityBookingUpdateType
  oldStatus  FacilityBookingStatus?
  newStatus  FacilityBookingStatus?
  message    String?
  createdBy  String?                   @db.Uuid
  createdAt  DateTime                  @default(now())

  booking FacilityBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  creator User?           @relation("FacilityBookingUpdateCreatedBy", fields: [createdBy], references: [id]) // ✅ named + opposite exists

  @@index([bookingId])
}

//////////////////////////////
// 14) Meter Reading
//////////////////////////////

model MeterCycle {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  cycleMonth DateTime         @db.Date
  status     MeterCycleStatus @default(OPEN)

  openedAt DateTime  @default(now())
  openedBy String?   @db.Uuid
  closedAt DateTime?
  closedBy String?   @db.Uuid

  condo  Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)
  opener User? @relation("MeterCycleOpenedBy", fields: [openedBy], references: [id])
  closer User? @relation("MeterCycleClosedBy", fields: [closedBy], references: [id])

  readings     MeterReading[]
  invoiceLinks InvoiceMeterLink[]

  @@unique([condoId, cycleMonth])
  @@index([condoId])
}

model MeterReading {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid
  roomId  String @db.Uuid
  cycleId String @db.Uuid

  prevWater    Decimal? @db.Decimal(12, 2)
  currWater    Decimal? @db.Decimal(12, 2)
  prevElectric Decimal? @db.Decimal(12, 2)
  currElectric Decimal? @db.Decimal(12, 2)

  waterUnits    Decimal? @db.Decimal(12, 2)
  electricUnits Decimal? @db.Decimal(12, 2)

  status     MeterReadingStatus @default(PENDING)
  recordedAt DateTime?
  recordedBy String?            @db.Uuid

  note      String?
  createdAt DateTime @default(now())

  condo    Condo      @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room     Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  cycle    MeterCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  recorder User?      @relation("MeterReadingRecordedBy", fields: [recordedBy], references: [id])

  attachments  MeterAttachment[]
  invoiceItems InvoiceItem[]

  @@unique([roomId, cycleId])
  @@index([condoId])
}

model MeterAttachment {
  id             String   @id @default(uuid()) @db.Uuid
  meterReadingId String   @db.Uuid
  fileUrl        String
  createdAt      DateTime @default(now())

  meterReading MeterReading @relation(fields: [meterReadingId], references: [id], onDelete: Cascade)

  @@index([meterReadingId])
}

//////////////////////////////
// 15) Billing + Payments
//////////////////////////////

model Invoice {
  id         String  @id @default(uuid()) @db.Uuid
  condoId    String  @db.Uuid
  roomId     String  @db.Uuid
  contractId String? @db.Uuid

  invoiceNo    String   @unique
  billingMonth DateTime @db.Date

  status InvoiceStatus @default(DRAFT)

  issuedAt DateTime?
  dueDate  DateTime? @db.Date

  subtotal      Decimal @default(0) @db.Decimal(12, 2)
  discountTotal Decimal @default(0) @db.Decimal(12, 2)
  penaltyTotal  Decimal @default(0) @db.Decimal(12, 2)
  totalAmount   Decimal @default(0) @db.Decimal(12, 2)

  note      String?
  createdBy String?   @db.Uuid
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  condo    Condo           @relation(fields: [condoId], references: [id], onDelete: Cascade)
  room     Room            @relation(fields: [roomId], references: [id], onDelete: Cascade)
  contract RentalContract? @relation(fields: [contractId], references: [id])
  creator  User?           @relation("InvoiceCreatedBy", fields: [createdBy], references: [id])

  items          InvoiceItem[]
  meterLinks     InvoiceMeterLink[]
  paymentNotices PaymentNotice[]
  paymentTxns    PaymentTransaction[]

  @@unique([roomId, billingMonth])
  @@index([condoId])
}

model InvoiceItem {
  id        String @id @default(uuid()) @db.Uuid
  invoiceId String @db.Uuid

  itemType InvoiceItemType
  itemName String
  amount   Decimal         @db.Decimal(12, 2)

  condoChargeId         String? @db.Uuid
  extraChargeTemplateId String? @db.Uuid
  meterReadingId        String? @db.Uuid
  facilityBookingId     String? @db.Uuid

  createdAt DateTime @default(now())

  invoice         Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  condoCharge     CondoCharge?         @relation(fields: [condoChargeId], references: [id])
  extraTemplate   ExtraChargeTemplate? @relation(fields: [extraChargeTemplateId], references: [id])
  meterReading    MeterReading?        @relation(fields: [meterReadingId], references: [id])
  facilityBooking FacilityBooking?     @relation(fields: [facilityBookingId], references: [id])

  @@index([invoiceId])
}

model InvoiceMeterLink {
  id        String @id @default(uuid()) @db.Uuid
  invoiceId String @db.Uuid
  cycleId   String @db.Uuid

  invoice Invoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  cycle   MeterCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, cycleId])
}

model PaymentNotice {
  id           String  @id @default(uuid()) @db.Uuid
  invoiceId    String  @db.Uuid
  tenantUserId String? @db.Uuid

  paidAmount      Decimal       @db.Decimal(12, 2)
  paidAt          DateTime?
  method          PaymentMethod
  bankReference   String?
  paidToAccountId String?       @db.Uuid

  status       PaymentNoticeStatus @default(PENDING)
  reviewedBy   String?             @db.Uuid
  reviewedAt   DateTime?
  rejectReason String?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  invoice       Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant        User?             @relation("PaymentNoticeTenant", fields: [tenantUserId], references: [id]) // ✅ named + opposite exists
  paidToAccount CondoBankAccount? @relation(fields: [paidToAccountId], references: [id])
  reviewer      User?             @relation("PaymentReviewedBy", fields: [reviewedBy], references: [id])

  attachments  PaymentAttachment[]
  transactions PaymentTransaction[]
  updates      PaymentUpdate[]

  @@index([invoiceId])
}

model PaymentAttachment {
  id              String   @id @default(uuid()) @db.Uuid
  paymentNoticeId String   @db.Uuid
  fileUrl         String
  createdAt       DateTime @default(now())

  notice PaymentNotice @relation(fields: [paymentNoticeId], references: [id], onDelete: Cascade)

  @@index([paymentNoticeId])
}

model PaymentTransaction {
  id              String  @id @default(uuid()) @db.Uuid
  condoId         String  @db.Uuid
  invoiceId       String  @db.Uuid
  paymentNoticeId String? @db.Uuid

  amount          Decimal       @db.Decimal(12, 2)
  method          PaymentMethod
  paidAt          DateTime?
  paidToAccountId String?       @db.Uuid

  status      PaymentTxnStatus @default(CONFIRMED)
  confirmedBy String?          @db.Uuid
  confirmedAt DateTime?

  createdAt DateTime @default(now())

  condo         Condo             @relation(fields: [condoId], references: [id], onDelete: Cascade)
  invoice       Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  notice        PaymentNotice?    @relation(fields: [paymentNoticeId], references: [id])
  paidToAccount CondoBankAccount? @relation(fields: [paidToAccountId], references: [id])
  confirmer     User?             @relation("PaymentConfirmedBy", fields: [confirmedBy], references: [id])

  @@index([condoId])
  @@index([invoiceId])
}

model PaymentUpdate {
  id              String               @id @default(uuid()) @db.Uuid
  paymentNoticeId String               @db.Uuid
  oldStatus       PaymentNoticeStatus?
  newStatus       PaymentNoticeStatus?
  message         String?
  updatedBy       String?              @db.Uuid
  createdAt       DateTime             @default(now())

  notice  PaymentNotice @relation(fields: [paymentNoticeId], references: [id], onDelete: Cascade)
  updater User?         @relation("PaymentUpdateBy", fields: [updatedBy], references: [id])

  @@index([paymentNoticeId])
}

//////////////////////////////
// 16) Tenant Notifications
//////////////////////////////

model TenantNotification {
  id           String  @id @default(uuid()) @db.Uuid
  tenantUserId String  @db.Uuid
  condoId      String? @db.Uuid

  type    TenantNotificationType
  title   String
  message String?
  refType String?
  refId   String?                @db.Uuid

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  tenant User   @relation("TenantNotificationUser", fields: [tenantUserId], references: [id], onDelete: Cascade)
  condo  Condo? @relation(fields: [condoId], references: [id])

  @@index([tenantUserId])
}

//////////////////////////////
// 17) Dashboard / Reports Snapshots
//////////////////////////////

model DashboardDailySnapshot {
  id           String   @id @default(uuid()) @db.Uuid
  condoId      String   @db.Uuid
  snapshotDate DateTime @db.Date

  totalRooms    Int?
  vacantRooms   Int?
  occupiedRooms Int?

  totalRevenue Decimal? @db.Decimal(12, 2)
  totalRepairs Int?
  totalParcels Int?

  createdAt DateTime @default(now())

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  @@unique([condoId, snapshotDate])
}

model ReportMonthlySnapshot {
  id      String @id @default(uuid()) @db.Uuid
  condoId String @db.Uuid

  month DateTime @db.Date

  totalIssued      Decimal @default(0) @db.Decimal(12, 2)
  totalPaid        Decimal @default(0) @db.Decimal(12, 2)
  totalOutstanding Decimal @default(0) @db.Decimal(12, 2)

  paidCount   Int @default(0)
  unpaidCount Int @default(0)

  createdAt DateTime @default(now())

  condo Condo @relation(fields: [condoId], references: [id], onDelete: Cascade)

  @@unique([condoId, month])
}
